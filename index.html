<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل نمایندگی - مرزبان VPN</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#CC9B50'
                    },
                    fontFamily: {
                        'vazir': ['Vazir', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://v1.fontapi.ir/css/Vazir');
        * { font-family: 'Vazir', Arial, sans-serif !important; }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5D5CDE;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <!-- Login Section -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="mx-auto w-20 h-20 bg-primary rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-shield-alt text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">پنل نمایندگی مرزبان</h1>
                <p class="text-gray-600 dark:text-gray-300 mt-2">برای ادامه وارد حساب کاربری خود شوید</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">نام کاربری</label>
                    <input type="text" id="username" required 
                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-base">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">رمز عبور</label>
                    <div class="relative">
                        <input type="password" id="password" required 
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-base">
                        <button type="button" onclick="togglePassword()" 
                                class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i id="passwordIcon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">آدرس سرور</label>
                    <input type="url" id="serverUrl" value="https://admin.jozveraygan.xyz:8443" required 
                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-base">
                </div>
                
                <div id="loginError" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 text-red-700 dark:text-red-300 text-sm"></div>
                
                <button type="submit" id="loginBtn" 
                        class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <span id="loginBtnText">ورود به پنل</span>
                    <div id="loginSpinner" class="loading-spinner hidden"></div>
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <button onclick="toggleDarkMode()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i id="themeIcon" class="fas fa-moon"></i>
                    <span id="themeText" class="mr-2">حالت تاریک</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Panel Section -->
    <div id="panelSection" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <i class="fas fa-shield-alt text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">پنل نمایندگی مرزبان</h1>
                        <p class="text-sm text-gray-600 dark:text-gray-300" id="welcomeText">خوش آمدید</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <button onclick="toggleDarkMode()" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i id="headerThemeIcon" class="fas fa-moon"></i>
                    </button>
                    <button onclick="logout()" class="flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>خروج</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
            <div class="px-6">
                <div class="flex space-x-8 rtl:space-x-reverse">
                    <button onclick="showSection('dashboard')" class="nav-item active border-b-2 border-primary text-primary px-1 py-4 text-sm font-medium">
                        <i class="fas fa-tachometer-alt ml-2"></i>داشبورد
                    </button>
                    <button onclick="showSection('users')" class="nav-item border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium">
                        <i class="fas fa-users ml-2"></i>کاربران
                    </button>
                    <button onclick="showSection('addUser')" class="nav-item border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium">
                        <i class="fas fa-user-plus ml-2"></i>افزودن کاربر
                    </button>
                    <button onclick="showSection('settings')" class="nav-item border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium">
                        <i class="fas fa-cog ml-2"></i>تنظیمات
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <main class="p-6">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 fade-in">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-users text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm text-gray-600 dark:text-gray-300">کل کاربران</p>
                                <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalUsers">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 fade-in">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-100 dark:bg-green-900/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-user-check text-green-600 dark:text-green-400"></i>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm text-gray-600 dark:text-gray-300">کاربران فعال</p>
                                <p class="text-2xl font-bold text-gray-900 dark:text-white" id="activeUsers">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 fade-in">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-user-times text-red-600 dark:text-red-400"></i>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm text-gray-600 dark:text-gray-300">کاربران غیرفعال</p>
                                <p class="text-2xl font-bold text-gray-900 dark:text-white" id="inactiveUsers">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 fade-in">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-download text-purple-600 dark:text-purple-400"></i>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm text-gray-600 dark:text-gray-300">کل ترافیک</p>
                                <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalTraffic">0 GB</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Users -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">کاربران اخیر</h3>
                    </div>
                    <div class="p-6">
                        <div id="recentUsersList" class="space-y-4">
                            <!-- Recent users will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">لیست کاربران</h3>
                            <button onclick="loadUsers()" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition">
                                <i class="fas fa-sync-alt"></i>
                                <span>بروزرسانی</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-4">
                            <input type="text" id="userSearch" placeholder="جستجوی کاربر..." 
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-base">
                        </div>
                        
                        <div id="usersTable" class="overflow-x-auto">
                            <!-- Users table will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add User Section -->
            <div id="addUserSection" class="section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">افزودن کاربر جدید</h3>
                    </div>
                    
                    <div class="p-6">
                        <form id="addUserForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">نام کاربری</label>
                                    <input type="text" id="newUsername" required 
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-base">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">حجم ترافیک (GB)</label>
                                    <input type="number" id="newDataLimit" required min="1" 
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-base">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">تاریخ انقضا</label>
                                    <input type="date" id="newExpireDate" required 
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-base">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">پروتکل</label>
                                    <select id="newProtocol" required 
                                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white text-base">
                                        <option value="vless">VLESS</option>
                                        <option value="vmess">VMess</option>
                                        <option value="trojan">Trojan</option>
                                        <option value="shadowsocks">Shadowsocks</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="addUserError" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 text-red-700 dark:text-red-300 text-sm"></div>
                            <div id="addUserSuccess" class="hidden bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3 text-green-700 dark:text-green-300 text-sm"></div>
                            
                            <button type="submit" id="addUserBtn" 
                                    class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                                <span id="addUserBtnText">افزودن کاربر</span>
                                <div id="addUserSpinner" class="loading-spinner hidden"></div>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="section hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">تنظیمات</h3>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">آدرس سرور</label>
                            <input type="url" id="settingsServerUrl" readonly 
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white text-base">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">نام کاربری</label>
                            <input type="text" id="settingsUsername" readonly 
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white text-base">
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div>
                                <h4 class="font-medium text-gray-900 dark:text-white">حالت تاریک</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-300">تغییر ظاهر رابط کاربری</p>
                            </div>
                            <button onclick="toggleDarkMode()" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2" id="darkModeToggle">
                                <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform dark:translate-x-6"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center gap-4">
            <div class="loading-spinner"></div>
            <span class="text-gray-900 dark:text-white">در حال بارگذاری...</span>
        </div>
    </div>

    <script>
        // Global Variables
        let authToken = '';
        let serverUrl = '';
        let currentUsername = '';
        let users = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            setupEventListeners();
            
            // Check if already logged in
            const storedToken = localStorage.getItem('marzban_token');
            const storedServer = localStorage.getItem('marzban_server');
            const storedUser = localStorage.getItem('marzban_username');
            
            if (storedToken && storedServer && storedUser) {
                authToken = storedToken;
                serverUrl = storedServer;
                currentUsername = storedUser;
                showPanel();
                loadDashboardData();
            }
        });

        // Theme Management
        function initializeTheme() {
            const isDark = localStorage.getItem('theme') === 'dark' || 
                          (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (isDark) {
                document.documentElement.classList.add('dark');
                updateThemeIcons(true);
            } else {
                updateThemeIcons(false);
            }
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcons(isDark);
        }

        function updateThemeIcons(isDark) {
            const icons = ['themeIcon', 'headerThemeIcon'];
            const texts = ['themeText'];
            
            icons.forEach(iconId => {
                const icon = document.getElementById(iconId);
                if (icon) {
                    icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
                }
            });
            
            texts.forEach(textId => {
                const text = document.getElementById(textId);
                if (text) {
                    text.textContent = isDark ? 'حالت روشن' : 'حالت تاریک';
                }
            });
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('userSearch').addEventListener('input', filterUsers);
            
            // Set default expire date to 30 days from now
            const expireDate = new Date();
            expireDate.setDate(expireDate.getDate() + 30);
            document.getElementById('newExpireDate').value = expireDate.toISOString().split('T')[0];
        }

        // Authentication
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const server = document.getElementById('serverUrl').value;
            
            setLoadingState('loginBtn', 'loginBtnText', 'loginSpinner', true);
            hideError('loginError');
            
            try {
                const response = await fetch(`${server}/api/admin/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'username': username,
                        'password': password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    serverUrl = server;
                    currentUsername = username;
                    
                    // Store credentials
                    localStorage.setItem('marzban_token', authToken);
                    localStorage.setItem('marzban_server', serverUrl);
                    localStorage.setItem('marzban_username', currentUsername);
                    
                    showPanel();
                    loadDashboardData();
                } else {
                    showError('loginError', 'نام کاربری یا رمز عبور اشتباه است');
                }
            } catch (error) {
                showError('loginError', 'خطا در اتصال به سرور');
            }
            
            setLoadingState('loginBtn', 'loginBtnText', 'loginSpinner', false);
        }

        function logout() {
            localStorage.removeItem('marzban_token');
            localStorage.removeItem('marzban_server');
            localStorage.removeItem('marzban_username');
            
            authToken = '';
            serverUrl = '';
            currentUsername = '';
            
            document.getElementById('panelSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            
            // Reset form
            document.getElementById('loginForm').reset();
            document.getElementById('serverUrl').value = 'https://admin.jozveraygan.xyz:8443';
        }

        // Panel Management
        function showPanel() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('panelSection').classList.remove('hidden');
            
            document.getElementById('welcomeText').textContent = `خوش آمدید، ${currentUsername}`;
            document.getElementById('settingsServerUrl').value = serverUrl;
            document.getElementById('settingsUsername').value = currentUsername;
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active');
            });
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'border-primary', 'text-primary');
                item.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300');
            });
            
            // Show selected section
            document.getElementById(`${sectionName}Section`).classList.remove('hidden');
            document.getElementById(`${sectionName}Section`).classList.add('active');
            
            // Update nav for active item
            event.target.classList.add('active', 'border-primary', 'text-primary');
            event.target.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300');
            
            // Load section data
            switch(sectionName) {
                case 'users':
                    loadUsers();
                    break;
                case 'dashboard':
                    loadDashboardData();
                    break;
            }
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${serverUrl}/api${endpoint}`, options);
                
                if (response.status === 401) {
                    logout();
                    return null;
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }

        // Dashboard Functions
        async function loadDashboardData() {
            showLoadingOverlay(true);
            
            try {
                const usersData = await apiCall('/users');
                
                if (usersData && usersData.users) {
                    users = usersData.users;
                    updateDashboardStats(users);
                    loadRecentUsers(users.slice(0, 5));
                }
            } catch (error) {
                console.error('Dashboard Error:', error);
            }
            
            showLoadingOverlay(false);
        }

        function updateDashboardStats(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active').length;
            const inactiveUsers = totalUsers - activeUsers;
            const totalTraffic = users.reduce((sum, user) => sum + (user.used_traffic || 0), 0);
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('inactiveUsers').textContent = inactiveUsers;
            document.getElementById('totalTraffic').textContent = formatBytes(totalTraffic);
        }

        function loadRecentUsers(recentUsers) {
            const container = document.getElementById('recentUsersList');
            container.innerHTML = '';
            
            if (recentUsers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">هیچ کاربری یافت نشد</p>';
                return;
            }
            
            recentUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg';
                userElement.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white">${user.username}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-300">ترافیک: ${formatBytes(user.used_traffic || 0)} / ${formatBytes(user.data_limit || 0)}</p>
                        </div>
                    </div>
                    <span class="px-2 py-1 text-xs rounded-full ${user.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400' : 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400'}">
                        ${user.status === 'active' ? 'فعال' : 'غیرفعال'}
                    </span>
                `;
                container.appendChild(userElement);
            });
        }

        // Users Management
        async function loadUsers() {
            showLoadingOverlay(true);
            
            try {
                const usersData = await apiCall('/users');
                
                if (usersData && usersData.users) {
                    users = usersData.users;
                    displayUsers(users);
                }
            } catch (error) {
                console.error('Users Error:', error);
            }
            
            showLoadingOverlay(false);
        }

        function displayUsers(usersToShow) {
            const container = document.getElementById('usersTable');
            
            if (usersToShow.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">هیچ کاربری یافت نشد</p>';
                return;
            }
            
            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">نام کاربری</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">وضعیت</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ترافیک</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاریخ انقضا</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">عملیات</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            `;
            
            usersToShow.forEach(user => {
                const expireDate = user.expire ? new Date(user.expire * 1000).toLocaleDateString('fa-IR') : 'نامحدود';
                const statusClass = user.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400' : 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400';
                const statusText = user.status === 'active' ? 'فعال' : 'غیرفعال';
                
                tableHTML += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center ml-3">
                                    <i class="fas fa-user text-white text-xs"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-900 dark:text-white">${user.username}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${statusText}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                            ${formatBytes(user.used_traffic || 0)} / ${formatBytes(user.data_limit || 0)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${expireDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="toggleUserStatus('${user.username}', '${user.status}')" 
                                    class="text-primary hover:text-primary/80 ml-3">
                                ${user.status === 'active' ? 'غیرفعال کردن' : 'فعال کردن'}
                            </button>
                            <button onclick="deleteUser('${user.username}')" 
                                    class="text-red-600 hover:text-red-800">حذف</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filteredUsers = users.filter(user => 
                user.username.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        }

        async function toggleUserStatus(username, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
            
            showLoadingOverlay(true);
            
            try {
                const result = await apiCall(`/user/${username}`, 'PUT', { status: newStatus });
                
                if (result) {
                    loadUsers(); // Reload users list
                    showSuccess('عملیات با موفقیت انجام شد');
                }
            } catch (error) {
                showError('usersError', 'خطا در تغییر وضعیت کاربر');
            }
            
            showLoadingOverlay(false);
        }

        async function deleteUser(username) {
            if (!confirm(`آیا از حذف کاربر "${username}" اطمینان دارید؟`)) {
                return;
            }
            
            showLoadingOverlay(true);
            
            try {
                const response = await fetch(`${serverUrl}/api/user/${username}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadUsers(); // Reload users list
                    showSuccess('کاربر با موفقیت حذف شد');
                } else {
                    showError('usersError', 'خطا در حذف کاربر');
                }
            } catch (error) {
                showError('usersError', 'خطا در حذف کاربر');
            }
            
            showLoadingOverlay(false);
        }

        // Add User Functions
        async function handleAddUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const dataLimit = parseFloat(document.getElementById('newDataLimit').value) * 1024 * 1024 * 1024; // Convert GB to bytes
            const expireDate = new Date(document.getElementById('newExpireDate').value);
            const protocol = document.getElementById('newProtocol').value;
            
            const expire = Math.floor(expireDate.getTime() / 1000); // Convert to Unix timestamp
            
            setLoadingState('addUserBtn', 'addUserBtnText', 'addUserSpinner', true);
            hideError('addUserError');
            hideSuccess('addUserSuccess');
            
            const userData = {
                username,
                data_limit: dataLimit,
                expire,
                proxies: {
                    [protocol]: {}
                }
            };
            
            try {
                const result = await apiCall('/user', 'POST', userData);
                
                if (result) {
                    showSuccess('addUserSuccess', 'کاربر با موفقیت اضافه شد');
                    document.getElementById('addUserForm').reset();
                    
                    // Reset expire date to 30 days from now
                    const newExpireDate = new Date();
                    newExpireDate.setDate(newExpireDate.getDate() + 30);
                    document.getElementById('newExpireDate').value = newExpireDate.toISOString().split('T')[0];
                } else {
                    showError('addUserError', 'خطا در افزودن کاربر');
                }
            } catch (error) {
                showError('addUserError', 'خطا در افزودن کاربر');
            }
            
            setLoadingState('addUserBtn', 'addUserBtnText', 'addUserSpinner', false);
        }

        // Utility Functions
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const passwordIcon = document.getElementById('passwordIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                passwordIcon.className = 'fas fa-eye';
            }
        }

        function setLoadingState(btnId, textId, spinnerId, loading) {
            const btn = document.getElementById(btnId);
            const text = document.getElementById(textId);
            const spinner = document.getElementById(spinnerId);
            
            btn.disabled = loading;
            if (loading) {
                text.style.display = 'none';
                spinner.classList.remove('hidden');
            } else {
                text.style.display = 'inline';
                spinner.classList.add('hidden');
            }
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideError(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add('hidden');
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            if (typeof elementId === 'string') {
                element.textContent = message;
                element.classList.remove('hidden');
            } else {
                // If elementId is actually the message (for general success)
                console.log('Success:', elementId);
            }
        }

        function hideSuccess(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add('hidden');
        }

        function showLoadingOverlay(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Dark mode media query listener
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (!localStorage.getItem('theme')) {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    updateThemeIcons(true);
                } else {
                    document.documentElement.classList.remove('dark');
                    updateThemeIcons(false);
                }
            }
        });
    </script>
</body>
</html>
