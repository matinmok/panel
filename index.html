Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ú©Ø¯ ÙØ¹Ù„ÛŒ Ø¨Ù‡ ÛŒÚ© Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ú©Ù‡ Ø¨Ù‡ Marzban (Ù¾Ø±ÙˆÚ˜Ù‡ Ù…ØªÙ†â€ŒØ¨Ø§Ø² Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆØ± VPN) Ù…ØªØµÙ„ Ø´ÙˆØ¯ Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒÛŒ Ù…Ø§Ù†Ù†Ø¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±ØŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ù†Ù‡Ø§ Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø³Ø§Ø³ÛŒ Ø¯Ø± Ú©Ø¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒÙ…. Ø¨Ø§ Ø§ÛŒÙ† Ø­Ø§Ù„ØŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ù…Ø´Ø®Øµ Ú©Ø±Ø¯Ù‡ Ú©Ù‡ Ø¸Ø§Ù‡Ø± (UI) Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ØŒ Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ† Ø³Ø§Ø®ØªØ§Ø± HTMLØŒ CSS Ùˆ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ÙØ¹Ù„ÛŒ Ø±Ø§ Ø­ÙØ¸ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ùˆ Ù…Ù†Ø·Ù‚ Ø¨Ú©â€ŒØ§Ù†Ø¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ API Marzban ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…. Ø¯Ø± Ø§ÛŒÙ† Ù¾Ø§Ø³Ø®ØŒ ÛŒÚ© Ú©Ø¯ Ú©Ø§Ù…Ù„ Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú©Ù‡ Ø¨Ø§ API Marzban Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø§Ù…Ø§ Ø§Ø² Ù‡Ù…Ø§Ù† Ø¸Ø§Ù‡Ø± Ùˆ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ø¯ Ø§ØµÙ„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.

### Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§
1. **Marzban API**: ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø³Ø±ÙˆØ± Marzban Ø±ÙˆÛŒ `https://admin.jozveraygan.xyz:8443` Ù†ØµØ¨ Ø´Ø¯Ù‡ Ùˆ API Ø¢Ù† ÙØ¹Ø§Ù„ Ø§Ø³Øª.
2. **ØªÙˆÚ©Ù† Ø¯Ø³ØªØ±Ø³ÛŒ**: Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API MarzbanØŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆÚ©Ù† Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø§Ø±ÛŒØ¯. Ø§ÛŒÙ† ØªÙˆÚ©Ù† Ø¨Ø§ÛŒØ¯ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙØ²ÙˆÙ†Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯.
3. **ÙˆØ±Ø¯Ù¾Ø±Ø³**: Ú©Ø¯ Ù‡Ù…Ú†Ù†Ø§Ù† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© Ø§ÙØ²ÙˆÙ†Ù‡ ÙˆØ±Ø¯Ù¾Ø±Ø³ Ø¹Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
4. **Ø­ÙØ¸ Ø¸Ø§Ù‡Ø±**: Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ Ø³Ø§Ø®ØªØ§Ø± HTML Ù…Ø´Ø§Ø¨Ù‡ Ú©Ø¯ Ø§ØµÙ„ÛŒ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯.
5. **Ø§Ù…Ù†ÛŒØª**: Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ APIØŒ Ø§Ø² cURL ÛŒØ§ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ HTTP Ù…Ø§Ù†Ù†Ø¯ Guzzle Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ùˆ ØªÙ…Ø§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ø§ SSL Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.

### ØªØºÛŒÛŒØ±Ø§Øª Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
1. **Ø­Ø°Ù Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ ØºÛŒØ±Ù…Ø±ØªØ¨Ø·**: Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒÛŒ Ù…Ø§Ù†Ù†Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§ØŒ Ù…Ù‚Ø§Ù„Ø§ØªØŒ Ùˆ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ø¬Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Marzban (Ø§ÛŒØ¬Ø§Ø¯ØŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ØŒ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ø­Ø°Ù) Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯.
2. **Ø§ØªØµØ§Ù„ Ø¨Ù‡ API Marzban**: Ø§Ø² API Marzban Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ØŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù…Ø§Ø± Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
3. **Ù†Ù‚Ø´ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ**: Ù†Ù‚Ø´ `modares` Ø¨Ù‡ `agent` ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ Ø§ÛŒÙ† Ù†Ù‚Ø´ Ø¨Ù‡ Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø¯Ø§Ø´Øª.
4. **Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†**: Ù‡Ø± Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ ÛŒÚ© ØªÙˆÚ©Ù† API Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Marzban Ø®ÙˆØ§Ù‡Ø¯ Ø¯Ø§Ø´Øª Ú©Ù‡ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„Ø´ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
5. **Ø­ÙØ¸ Ø¸Ø§Ù‡Ø±**: Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø«Ø§Ø¨Øª Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯.

### Ú©Ø¯ Ú©Ø§Ù…Ù„
```php
<?php
/*
Plugin Name: Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø¬Ø²ÙˆØ±Ø§ÛŒÚ¯Ø§Ù†
Description: Ø§ÙØ²ÙˆÙ†Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† VPN Ø¯Ø± Marzban
Version: 1.0
Author: ØªÛŒÙ… Ø¬Ø²ÙˆØ±Ø§ÛŒÚ¯Ø§Ù†
Text Domain: jozveraygan-agent
*/
defined('ABSPATH') || exit;

// ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
function jozveraygan_gregorian_to_jalali($date) {
    if (empty($date)) return $date;
    
    $date = strtotime($date);
    if ($date === false) return $date;
    
    $formatted_date = date_i18n('Y/m/d H:i', $date);
    $persian_numbers = array('Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹');
    $english_numbers = range(0, 9);
    
    return str_replace($english_numbers, $persian_numbers, $formatted_date);
}

// ØªØ§Ø¨Ø¹ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ API Marzban
function jozveraygan_marzban_api_request($endpoint, $method = 'GET', $data = [], $token = '') {
    $url = 'https://admin.jozveraygan.xyz:8443/api' . $endpoint;
    $args = [
        'headers' => [
            'Authorization' => 'Bearer ' . $token,
            'Content-Type' => 'application/json',
        ],
        'timeout' => 30,
        'sslverify' => true, // Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ÛŒØ¯ true Ø¨Ø§Ø´Ø¯
    ];

    if ($method === 'POST' || $method === 'PUT') {
        $args['body'] = json_encode($data);
    }

    $response = wp_remote_request($url, array_merge($args, ['method' => $method]));
    
    if (is_wp_error($response)) {
        error_log('Marzban API Error: ' . $response->get_error_message());
        return ['success' => false, 'error' => $response->get_error_message()];
    }

    $body = json_decode(wp_remote_retrieve_body($response), true);
    return [
        'success' => wp_remote_retrieve_response_code($response) >= 200 && wp_remote_retrieve_response_code($response) < 300,
        'data' => $body,
    ];
}

// ØªØ§Ø¨Ø¹ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø² Marzban
function jozveraygan_get_marzban_users($token) {
    $response = jozveraygan_marzban_api_request('/user', 'GET', [], $token);
    if ($response['success']) {
        return $response['data']['users'] ?? [];
    }
    return [];
}

// ØªØ§Ø¨Ø¹ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Marzban
function jozveraygan_add_marzban_user($username, $data_limit, $expire, $token) {
    $data = [
        'username' => $username,
        'data_limit' => $data_limit * 1024 * 1024 * 1024, // ØªØ¨Ø¯ÛŒÙ„ Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª Ø¨Ù‡ Ø¨Ø§ÛŒØª
        'expire' => $expire,
        'proxies' => ['vless' => [], 'vmess' => [], 'trojan' => []], // ØªÙ†Ø¸ÛŒÙ… Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    ];
    return jozveraygan_marzban_api_request('/user', 'POST', $data, $token);
}

// ØªØ§Ø¨Ø¹ Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Marzban
function jozveraygan_delete_marzban_user($username, $token) {
    return jozveraygan_marzban_api_request('/user/' . $username, 'DELETE', [], $token);
}

// ØªØ§Ø¨Ø¹ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Marzban
function jozveraygan_edit_marzban_user($username, $data_limit, $expire, $token) {
    $data = [
        'data_limit' => $data_limit * 1024 * 1024 * 1024, // ØªØ¨Ø¯ÛŒÙ„ Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª Ø¨Ù‡ Ø¨Ø§ÛŒØª
        'expire' => $expire,
    ];
    return jozveraygan_marzban_api_request('/user/' . $username, 'PUT', $data, $token);
}

// Ø«Ø¨Øª Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§
add_action('wp_enqueue_scripts', function () {
    wp_enqueue_style('jozveraygan-vazir-font', 'https://v1.fontapi.ir/css/Vazir', [], '1.0');
});
add_action('admin_enqueue_scripts', function () {
    wp_enqueue_style('jozveraygan-vazir-font', 'https://v1.fontapi.ir/css/Vazir', [], '1.0');
});

// Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡
add_action('init', function () {
    add_role('agent', 'Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡', ['read' => true, 'edit_posts' => true, 'upload_files' => true]);
});

// Ø«Ø¨Øª Ø¬Ø¯Ø§ÙˆÙ„ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡
register_activation_hook(__FILE__, function () {
    global $wpdb;
    $charset_collate = $wpdb->get_charset_collate();
    $tables = [
        "CREATE TABLE {$wpdb->prefix}jozveraygan_notifications (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            user_id bigint(20) NOT NULL,
            title varchar(255) NOT NULL,
            message text NOT NULL,
            type varchar(50) NOT NULL,
            is_read tinyint(1) DEFAULT 0,
            created_at datetime NOT NULL,
            PRIMARY KEY (id)
        ) $charset_collate;"
    ];
    require_once ABSPATH . 'wp-admin/includes/upgrade.php';
    foreach ($tables as $sql) dbDelta($sql);
});

// ØªØ§Ø¨Ø¹ Ø«Ø¨Øª Ø§Ø¹Ù„Ø§Ù†
function jozveraygan_add_notification($user_id, $title, $message, $type = 'info') {
    global $wpdb;
    return $wpdb->insert(
        $wpdb->prefix . 'jozveraygan_notifications',
        [
            'user_id' => $user_id,
            'title' => $title,
            'message' => $message,
            'type' => $type,
            'created_at' => current_time('mysql')
        ],
        ['%d', '%s', '%s', '%s', '%s']
    );
}

// ØªØ§Ø¨Ø¹ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ø§Ø¹Ù„Ø§Ù†
function jozveraygan_send_admin_notification($subject, $message) {
    wp_mail(get_option('admin_email'), $subject, $message, ['Content-Type: text/html; charset=UTF-8']);
}

// Ø´ÙˆØ±Øªâ€ŒÚ©Ø¯ Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ
add_shortcode('jozveraygan-agent', function () {
    ob_start();
    if (wp_is_mobile()) {
        ?>
        <style>
            *{margin:0;padding:0;box-sizing:border-box;font-family:'Vazir',Arial,sans-serif!important}.jozveraygan-error-fullpage{position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;justify-content:center;align-items:center;z-index:9999}.jozveraygan-error-container{background:#fff;border-radius:20px;padding:50px 40px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.1);max-width:450px;width:90%;animation:fadeInUp 0.6s ease-out}.jozveraygan-error-icon{font-size:80px;margin-bottom:20px;color:#667eea}.jozveraygan-error-title{font-size:28px;color:#333;margin-bottom:15px;font-weight:700}.jozveraygan-error-text{font-size:16px;color:#666;line-height:1.6;margin-bottom:30px}.jozveraygan-error-btn{display:inline-block;padding:12px 30px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:25px;text-decoration:none;font-size:16px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(102,126,234,0.3)}.jozveraygan-error-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.4);color:#fff}@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}@media (max-width:480px){.jozveraygan-error-container{padding:40px 30px}.jozveraygan-error-title{font-size:24px}.jozveraygan-error-text{font-size:14px}.jozveraygan-error-btn{font-size:14px;padding:10px 25px}}
        </style>
        <div class="jozveraygan-error-fullpage">
            <div class="jozveraygan-error-container">
                <div class="jozveraygan-error-icon">ğŸ’»</div>
                <h1 class="jozveraygan-error-title">Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯</h1>
                <p class="jozveraygan-error-text">Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø¬Ø²ÙˆØ±Ø§ÛŒÚ¯Ø§Ù† Ù„Ø·ÙØ§ Ø¨Ø§ Ù„Ù¾ØªØ§Ù¾ Ùˆ ÛŒØ§ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ± ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯!</p>
                <a href="<?php echo esc_url(home_url()); ?>" class="jozveraygan-error-btn">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }
    if (!is_user_logged_in()) {
        ?>
        <style>
            *{margin:0;padding:0;box-sizing:border-box;font-family:'Vazir',Arial,sans-serif!important}.jozveraygan-error-fullpage{position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;justify-content:center;align-items:center;z-index:9999}.jozveraygan-error-container{background:#fff;border-radius:20px;padding:50px 40px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.1);max-width:450px;width:90%;animation:fadeInUp 0.6s ease-out}.jozveraygan-error-icon{font-size:80px;margin-bottom:20px;color:#667eea}.jozveraygan-error-title{font-size:28px;color:#333;margin-bottom:15px;font-weight:700}.jozveraygan-error-text{font-size:16px;color:#666;line-height:1.6;margin-bottom:30px}.jozveraygan-error-btn{display:inline-block;padding:12px 30px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:25px;text-decoration:none;font-size:16px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(102,126,234,0.3)}.jozveraygan-error-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.4);color:#fff}@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}@media (max-width:480px){.jozveraygan-error-container{padding:40px 30px}.jozveraygan-error-title{font-size:24px}.jozveraygan-error-text{font-size:14px}.jozveraygan-error-btn{font-size:14px;padding:10px 25px}}
        </style>
        <div class="jozveraygan-error-fullpage">
            <div class="jozveraygan-error-container">
                <div class="jozveraygan-error-icon">ğŸ”</div>
                <h1 class="jozveraygan-error-title">Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯</h1>
                <p class="jozveraygan-error-text">Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.</p>
                <a href="<?php echo esc_url(wp_login_url()); ?>" class="jozveraygan-error-btn">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</a>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }
    $user = wp_get_current_user();
    if (!in_array('agent', (array)$user->roles)) {
        ?>
        <style>
            *{margin:0;padding:0;box-sizing:border-box;font-family:'Vazir',Arial,sans-serif!important}.jozveraygan-error-fullpage{position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;justify-content:center;align-items:center;z-index:9999}.jozveraygan-error-container{background:#fff;border-radius:20px;padding:50px 40px;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,0.1);max-width:450px;width:90%;animation:fadeInUp 0.6s ease-out}.jozveraygan-error-icon{font-size:80px;margin-bottom:20px;color:#667eea}.jozveraygan-error-title{font-size:28px;color:#333;margin-bottom:15px;font-weight:700}.jozveraygan-error-text{font-size:16px;color:#666;line-height:1.6;margin-bottom:30px}.jozveraygan-error-btn{display:inline-block;padding:12px 30px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:25px;text-decoration:none;font-size:16px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(102,126,234,0.3)}.jozveraygan-error-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,0.4);color:#fff}@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}@media (max-width:480px){.jozveraygan-error-container{padding:40px 30px}.jozveraygan-error-title{font-size:24px}.jozveraygan-error-text{font-size:14px}.jozveraygan-error-btn{font-size:14px;padding:10px 25px}}
        </style>
        <div class="jozveraygan-error-fullpage">
            <div class="jozveraygan-error-container">
                <div class="jozveraygan-error-icon">âš ï¸</div>
                <h1 class="jozveraygan-error-title">Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²</h1>
                <p class="jozveraygan-error-text">Ø§ÛŒÙ† Ù¾Ù†Ù„ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù† Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø³Øª.</p>
                <a href="<?php echo esc_url(home_url()); ?>" class="jozveraygan-error-btn">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }

    $token = get_user_meta($user->ID, 'jozveraygan_marzban_token', true);
    $profile_picture = get_user_meta($user->ID, 'jozveraygan_profile_picture', true) ?: get_avatar_url($user->ID, ['size' => 100]);
    $notification = '';

    // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙØ±Ù…
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['nonce']) && wp_verify_nonce($_POST['nonce'], 'jozveraygan_action')) {
        if (isset($_POST['add_user']) && !empty($_POST['username']) && !empty($_POST['data_limit']) && !empty($_POST['expire'])) {
            $result = jozveraygan_add_marzban_user(sanitize_text_field($_POST['username']), floatval($_POST['data_limit']), strtotime($_POST['expire']), $token);
            if ($result['success']) {
                $notification = '<div class="jozveraygan-notification jozveraygan-success">Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯.</div>';
                jozveraygan_add_notification(1, 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯', sprintf('Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ %s Ú©Ø§Ø±Ø¨Ø± %s Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø±Ø¯.', $user->display_name, $_POST['username']), 'user');
                jozveraygan_send_admin_notification('Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯', sprintf('Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ %s Ú©Ø§Ø±Ø¨Ø± %s Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø±Ø¯.', $user->display_name, $_POST['username']));
            } else {
                $notification = '<div class="jozveraygan-notification jozveraygan-error">Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±: ' . esc_html($result['error'] ?? 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡') . '</div>';
            }
        } elseif (isset($_POST['delete_user']) && !empty($_POST['username'])) {
            $result = jozveraygan_delete_marzban_user(sanitize_text_field($_POST['username']), $token);
            if ($result['success']) {
                $notification = '<div class="jozveraygan-notification jozveraygan-success">Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.</div>';
                jozveraygan_add_notification(1, 'Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±', sprintf('Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ %s Ú©Ø§Ø±Ø¨Ø± %s Ø±Ø§ Ø­Ø°Ù Ú©Ø±Ø¯.', $user->display_name, $_POST['username']), 'user');
                jozveraygan_send_admin_notification('Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±', sprintf('Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ %s Ú©Ø§Ø±Ø¨Ø± %s Ø±Ø§ Ø­Ø°Ù Ú©Ø±Ø¯.', $user->display_name, $_POST['username']));
            } else {
                $notification = '<div class="jozveraygan-notification jozveraygan-error">Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±: ' . esc_html($result['error'] ?? 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡') . '</div>';
            }
        } elseif (isset($_POST['edit_user']) && !empty($_POST['username']) && !empty($_POST['data_limit']) && !empty($_POST['expire'])) {
            $result = jozveraygan_edit_marzban_user(sanitize_text_field($_POST['username']), floatval($_POST['data_limit']), strtotime($_POST['expire']), $token);
            if ($result['success']) {
                $notification = '<div class="jozveraygan-notification jozveraygan-success">Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯.</div>';
                jozveraygan_add_notification(1, 'ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±', sprintf('Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ %s Ú©Ø§Ø±Ø¨Ø± %s Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø±Ø¯.', $user->display_name, $_POST['username']), 'user');
                jozveraygan_send_admin_notification('ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±', sprintf('Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ %s Ú©Ø§Ø±Ø¨Ø± %s Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø±Ø¯.', $user->display_name, $_POST['username']));
            } else {
                $notification = '<div class="jozveraygan-notification jozveraygan-error">Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±: ' . esc_html($result['error'] ?? 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡') . '</div>';
            }
        }
    }

    $users = jozveraygan_get_marzban_users($token);
    $user_count = count($users);
    ?>
    <style>
        *{font-family:'Vazir',Arial,sans-serif!important;box-sizing:border-box}.jozveraygan-panel{display:flex;flex-direction:row-reverse;width:100vw;height:100vh;position:fixed;top:0;left:0;background:#fff}.jozveraygan-nav{width:220px;background:#1a3c5e;color:#fff;display:flex;flex-direction:column;padding:15px;height:100%;box-shadow:-2px 0 8px rgba(0,0,0,0.1)}.jozveraygan-nav button{background:none;color:#fff;border:none;padding:10px;text-align:right;font-size:15px;cursor:pointer;border-radius:5px;margin:3px 0}.jozveraygan-nav button:hover,.jozveraygan-nav button.active{background:#CC9B50}.jozveraygan-content{flex:1;padding:20px;background:#f4f6f9;overflow-y:auto;height:100%;padding-bottom:80px}.jozveraygan-header-mobile{display:none;position:sticky;top:0;background:#1a3c5e;color:#fff;padding:10px;z-index:1000;text-align:center;font-size:18px}.jozveraygan-hamburger{display:none;position:absolute;right:10px;top:10px;background:none;border:none;color:#fff;font-size:24px;cursor:pointer}.jozveraygan-nav-mobile{display:none;flex-direction:column;background:#1a3c5e;position:absolute;top:50px;right:10px;width:200px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.2)}.jozveraygan-nav-mobile button{background:none;color:#fff;border:none;padding:10px;text-align:right;font-size:14px;cursor:pointer;border-radius:5px;margin:3px 0}.jozveraygan-nav-mobile button:hover,.jozveraygan-nav-mobile button.active{background:#CC9B50}.jozveraygan-title{color:#1a3c5e;font-size:28px;margin-bottom:25px;text-align:center;font-weight:700;border-bottom:2px solid #CC9B50;padding-bottom:15px}.jozveraygan-profile{background:#fff;padding:15px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.05);display:flex;align-items:center;gap:15px;margin-bottom:20px}.jozveraygan-profile img{width:60px;height:60px;border-radius:50%;object-fit:cover}.jozveraygan-profile-info p{margin:5px 0;color:#4a5b6e;font-size:14px}.jozveraygan-section{display:none;background:#fff;padding:20px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.05)}.jozveraygan-section.active{display:block}.jozveraygan-section h3{color:#1a3c5e;font-size:20px;margin-bottom:10px;text-align:right}.jozveraygan-section label{display:block;margin:8px 0 4px;font-weight:bold;color:#4a5b6e;font-size:13px}.jozveraygan-section input,.jozveraygan-section textarea{width:100%;padding:10px;border:1px solid #d1d9e0;border-radius:6px;font-size:13px}.jozveraygan-section button{background:#CC9B50;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:13px}.jozveraygan-section button:hover{background:#b5893f}.jozveraygan-users{display:grid;gap:10px}.jozveraygan-user{background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #e0e6ed}.jozveraygan-notification{padding:10px;border-radius:6px;margin-bottom:15px;text-align:center;font-size:13px}.jozveraygan-notification.jozveraygan-success{background:#e6f4ea;color:#2e7d32}.jozveraygan-notification.jozveraygan-error{background:#f8d7da;color:#721c24}.jozveraygan-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;background:#fff;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.05)}.jozveraygan-table th,.jozveraygan-table td{border:1px solid #e0e6ed;padding:10px;text-align:right;font-size:13px}.jozveraygan-table th{background:#f8fafc;color:#1a3c5e}.jozveraygan-table tr:hover{background:#f9f9f9}.jozveraygan-status{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}.jozveraygan-status-card{background:#fff;padding:15px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.05);text-align:right}.jozveraygan-status-card h4{color:#1a3c5e;font-size:16px;margin-bottom:8px}.jozveraygan-status-card p{color:#4a5b6e;font-size:14px;margin:4px 0}.jozveraygan-footer{text-align:center;color:#9ca3af;font-size:11px;padding:40px 20px 30px;margin-top:50px;border-top:1px solid #e5e7eb;background:rgba(248,250,252,0.5)}@media (max-width:768px){.jozveraygan-panel{flex-direction:column;height:auto;position:static}.jozveraygan-nav{display:none}.jozveraygan-header-mobile{display:block}.jozveraygan-hamburger{display:block}.jozveraygan-nav-mobile.active{display:flex}.jozveraygan-content{padding:10px;padding-bottom:60px}.jozveraygan-title{font-size:22px;margin-bottom:20px}.jozveraygan-profile{flex-direction:column;align-items:flex-end}.jozveraygan-profile img{width:50px;height:50px}.jozveraygan-section h3{font-size:18px}.jozveraygan-status{grid-template-columns:1fr}.jozveraygan-section,.jozveraygan-status-card,.jozveraygan-user,.jozveraygan-table{border:1px solid #d1d9e0;border-radius:8px}.jozveraygan-footer{padding:25px 15px 20px}}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script>
        function showSection(id) {
            document.querySelectorAll('.jozveraygan-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.jozveraygan-nav button, .jozveraygan-nav-mobile button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll(`button[data-section="${id}"]`).forEach(b => b.classList.add('active'));
            if (id === 'section-analytics') {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                if (ctx.chart) ctx.chart.destroy();
                ctx.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Ú©Ø§Ø±Ø¨Ø±Ø§Ù†'],
                        datasets: [{
                            label: 'Ø¢Ù…Ø§Ø±',
                            data: [<?php echo $user_count; ?>],
                            backgroundColor: ['#CC9B50'],
                            borderColor: ['#CC9B50'],
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { labels: { font: { size: 13 } } } },
                        responsive: true
                    }
                });
            }
        }
        function toggleMobileMenu() {
            document.querySelector('.jozveraygan-nav-mobile').classList.toggle('active');
        }
        document.addEventListener('DOMContentLoaded', function() {
            const notifications = document.querySelectorAll('.jozveraygan-notification');
            notifications.forEach(notification => {
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            });
        });
    </script>
    <div class="jozveraygan-panel">
        <div class="jozveraygan-header-mobile">Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ
            <button class="jozveraygan-hamburger" onclick="toggleMobileMenu()">â˜°</button>
        </div>
        <div class="jozveraygan-nav-mobile">
            <button class="active" data-section="section-status" onclick="showSection('section-status');toggleMobileMenu()">ÙˆØ¶Ø¹ÛŒØª Ø­Ø³Ø§Ø¨</button>
            <button data-section="section-users" onclick="showSection('section-users');toggleMobileMenu()">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
            <button data-section="section-analytics" onclick="showSection('section-analytics');toggleMobileMenu()">ØªØ­Ù„ÛŒÙ„</button>
        </div>
        <div class="jozveraygan-nav">
            <button class="active" data-section="section-status" onclick="showSection('section-status')">ÙˆØ¶Ø¹ÛŒØª Ø­Ø³Ø§Ø¨</button>
            <button data-section="section-users" onclick="showSection('section-users')">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
            <button data-section="section-analytics" onclick="showSection('section-analytics')">ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯</button>
        </div>
        <div class="jozveraygan-content">
            <h1 class="jozveraygan-title">Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø¬Ø²ÙˆØ±Ø§ÛŒÚ¯Ø§Ù†</h1>
            <?php echo $notification; ?>
            <div class="jozveraygan-profile">
                <img src="<?php echo esc_url($profile_picture); ?>" alt="Ù¾Ø±ÙˆÙØ§ÛŒÙ„">
                <div class="jozveraygan-profile-info">
                    <p><strong>Ù†Ø§Ù…:</strong> <?php echo esc_html($user->display_name); ?></p>
                    <p><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> <?php echo esc_html($user->user_email); ?></p>
                </div>
            </div>
            <div id="section-status" class="jozveraygan-section active">
                <h3>ÙˆØ¶Ø¹ÛŒØª Ø­Ø³Ø§Ø¨</h3>
                <div class="jozveraygan-status">
                    <div class="jozveraygan-status-card"><h4>ØªØ§Ø±ÛŒØ®</h4><p><?php echo esc_html(jozveraygan_gregorian_to_jalali(date_i18n('Y/m/d H:i'))); ?></p></div>
                    <div class="jozveraygan-status-card"><h4>Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h4><p><strong>Ù†Ø§Ù…:</strong> <?php echo esc_html($user->display_name); ?></p><p><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> <?php echo esc_html($user->user_email); ?></p></div>
                    <div class="jozveraygan-status-card"><h4>Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h4><p><strong>ØªØ¹Ø¯Ø§Ø¯:</strong> <?php echo esc_html($user_count); ?></p></div>
                </div>
            </div>
            <div id="section-users" class="jozveraygan-section">
                <h3>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
                <form method="post">
                    <input type="hidden" name="nonce" value="<?php echo wp_create_nonce('jozveraygan_action'); ?>">
                    <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label><input type="text" name="username" required>
                    <label>Ø­Ø¬Ù… (Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª)</label><input type="number" name="data_limit" min="1" required>
                    <label>ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§</label><input type="date" name="expire" required>
                    <button type="submit" name="add_user">Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±</button>
                </form>
                <h3>Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
                <table class="jozveraygan-table">
                    <tr><th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th><th>Ø­Ø¬Ù… (GB)</th><th>Ø§Ù†Ù‚Ø¶Ø§</th><th>ÙˆØ¶Ø¹ÛŒØª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
                    <?php
                    foreach ($users as $u) {
                        $data_limit = round($u['data_limit'] / (1024 * 1024 * 1024), 2); // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ø§ÛŒØª Ø¨Ù‡ Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª
                        $expire = $u['expire'] ? date('Y-m-d', $u['expire']) : 'Ø¨Ø¯ÙˆÙ† Ø§Ù†Ù‚Ø¶Ø§';
                        $status = $u['status'] === 'active' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„';
                        echo '<tr>';
                        echo '<td>' . esc_html($u['username']) . '</td>';
                        echo '<td>' . esc_html($data_limit) . '</td>';
                        echo '<td>' . esc_html($expire) . '</td>';
                        echo '<td>' . esc_html($status) . '</td>';
                        echo '<td>';
                        echo '<form method="post" style="display:inline"><input type="hidden" name="nonce" value="' . wp_create_nonce('jozveraygan_action') . '"><input type="hidden" name="username" value="' . esc_attr($u['username']) . '"><input type="number" name="data_limit" value="' . esc_attr($data_limit) . '" min="1" style="width:80px"><input type="date" name="expire" value="' . esc_attr($expire === 'Ø¨Ø¯ÙˆÙ† Ø§Ù†Ù‚Ø¶Ø§' ? '' : $expire) . '"><button type="submit" name="edit_user">ÙˆÛŒØ±Ø§ÛŒØ´</button></form>';
                        echo '<form method="post" style="display:inline" onsubmit="return confirm(\'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ\');"><input type="hidden" name="nonce" value="' . wp_create_nonce('jozveraygan_action') . '"><input type="hidden" name="username" value="' . esc_attr($u['username']) . '"><button type="submit" name="delete_user">Ø­Ø°Ù</button></form>';
                        echo '</td>';
                        echo '</tr>';
                    }
                    if (empty($users)) echo '<tr><td colspan="5">Ø¨Ø¯ÙˆÙ† Ú©Ø§Ø±Ø¨Ø±.</td></tr>';
                    ?>
                </table>
            </div>
            <div id="section-analytics" class="jozveraygan-section">
                <h3>ØªØ­Ù„ÛŒÙ„</h3>
                <p><strong>ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</strong> <?php echo esc_html($user_count); ?></p>
                <canvas id="performanceChart"></canvas>
            </div>
            <div class="jozveraygan-footer">
                ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… Ø¬Ø²ÙˆØ±Ø§ÛŒÚ¯Ø§Ù† Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª | Ø·Ø±Ø§Ø­ÛŒ Ùˆ ØªÙˆØ³Ø¹Ù‡ ÛŒØ§ÙØªÙ‡ ØªÙˆØ³Ø· ØªÛŒÙ… Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ Ø¬Ø²ÙˆØ±Ø§ÛŒÚ¯Ø§Ù†
            </div>
        </div>
    </div>
    <?php
    return ob_get_clean();
});

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø¹Ù„Ø§Ù† Ø¯Ø± Ù‡Ø¯Ø± Ø§Ø¯Ù…ÛŒÙ†
add_action('admin_bar_menu', function($wp_admin_bar) {
    if (!current_user_can('manage_options')) return;
    
    global $wpdb;
    $unread_count = (int)$wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->prefix}jozveraygan_notifications WHERE is_read = 0");
    
    $wp_admin_bar->add_node([
        'id' => 'jozveraygan-notifications',
        'title' => '<span class="ab-icon dashicons dashicons-welcome-learn-more"></span><span class="ab-label">Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ</span>' . ($unread_count > 0 ? '<span class="jozveraygan-notification-count">' . $unread_count . '</span>' : ''),
        'href' => admin_url('admin.php?page=jozveraygan-notifications'),
        'meta' => ['class' => 'jozveraygan-notification-item']
    ]);
}, 100);

// CSS Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ø¯Ø± Ù‡Ø¯Ø±
add_action('admin_head', function() {
    echo '<style>
    .jozveraygan-notification-count {
        background: #d63638;
        color: #fff;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 11px;
        margin-left: 5px;
        display: inline-block;
        min-width: 18px;
        text-align: center;
        line-height: 1.2;
    }
    .jozveraygan-notification-item .ab-item {
        position: relative;
    }
    </style>';
});

add_action('admin_menu', function () {
    add_menu_page('Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†', 'Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†', 'manage_options', 'jozveraygan-panel', 'jozveraygan_admin_panel', 'dashicons-welcome-learn-more', 30);
    add_submenu_page('jozveraygan-panel', 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', 'Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', 'manage_options', 'jozveraygan-users', 'jozveraygan_users_panel');
    add_submenu_page('jozveraygan-panel', 'Ø§Ø¹Ù„Ø§Ù†Ø§Øª', 'Ø§Ø¹Ù„Ø§Ù†Ø§Øª', 'manage_options', 'jozveraygan-notifications', 'jozveraygan_notifications_panel');
});

function jozveraygan_notifications_panel() {
    global $wpdb;
    $notifications_table = $wpdb->prefix . 'jozveraygan_notifications';
    
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['mark_read']) && wp_verify_nonce($_POST['nonce'], 'jozveraygan_notifications_action')) {
        if (isset($_POST['notification_ids']) && is_array($_POST['notification_ids'])) {
            $ids = array_map('absint', $_POST['notification_ids']);
            $placeholders = implode(',', array_fill(0, count($ids), '%d'));
            $wpdb->query($wpdb->prepare("UPDATE {$notifications_table} SET is_read = 1 WHERE id IN ($placeholders)", ...$ids));
            echo '<div class="notice notice-success"><p>Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯.</p></div>';
        }
    }
    
    $notifications = $wpdb->get_results("SELECT * FROM {$notifications_table} ORDER BY created_at DESC");
    ?>
    <style>
        .jozveraygan-notifications-container{max-width:1200px;margin:15px auto;padding:15px}.jozveraygan-notifications-header{font-size:32px;color:#1a3c5e;margin-bottom:20px;text-align:center}.jozveraygan-notifications-card{background:#fff;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1);padding:20px;margin-bottom:20px}.jozveraygan-notifications-card h3{font-size:22px;color:#1a3c5e;margin-bottom:15px;text-align:right}.jozveraygan-notifications-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:15px;background:#fff;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.05)}.jozveraygan-notifications-table th,.jozveraygan-notifications-table td{border:1px solid #e0e6ed;padding:10px;text-align:right;font-size:13px}.jozveraygan-notifications-table th{background:#f8fafc;color:#1a3c5e}.jozveraygan-notifications-table tr:hover{background:#f4f6f9}.jozveraygan-notifications-table tr.unread{background:#fff3cd;border-left:4px solid #ffc107}.jozveraygan-notifications-table tr.unread:hover{background:#fff3e0}.notification-type{padding:3px 8px;border-radius:12px;font-size:11px;color:#fff}.notification-type.user{background:#17a2b8}.jozveraygan-mark-read-form{margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:6px}.jozveraygan-mark-read-form button{background:#28a745;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer}.jozveraygan-mark-read-form button:hover{background:#218838}.select-all-checkbox{margin-left:10px}
    </style>
    <div class="jozveraygan-notifications-container">
        <h1 class="jozveraygan-notifications-header">Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†</h1>
        <div class="jozveraygan-notifications-card">
            <h3>Ø§Ø¹Ù„Ø§Ù†Ø§Øª</h3>
            <?php if ($notifications): ?>
                <form method="post" class="jozveraygan-mark-read-form">
                    <input type="hidden" name="nonce" value="<?php echo wp_create_nonce('jozveraygan_notifications_action'); ?>">
                    <label>
                        <input type="checkbox" id="select-all" class="select-all-checkbox"> Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡
                    </label>
                    <button type="submit" name="mark_read">Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡</button>
                    <table class="jozveraygan-notifications-table">
                        <tr>
                            <th>Ø§Ù†ØªØ®Ø§Ø¨</th>
                            <th>Ù†ÙˆØ¹</th>
                            <th>Ø¹Ù†ÙˆØ§Ù†</th>
                            <th>Ù¾ÛŒØ§Ù…</th>
                            <th>Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</th>
                            <th>ØªØ§Ø±ÛŒØ®</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                        </tr>
                        <?php foreach ($notifications as $notification): 
                            $user = get_user_by('id', $notification->user_id);
                            $type_labels = ['user' => 'Ú©Ø§Ø±Ø¨Ø±'];
                        ?>
                            <tr<?php echo !$notification->is_read ? ' class="unread"' : ''; ?>>
                                <td>
                                    <input type="checkbox" name="notification_ids[]" value="<?php echo $notification->id; ?>" class="notification-checkbox">
                                </td>
                                <td>
                                    <span class="notification-type <?php echo esc_attr($notification->type); ?>">
                                        <?php echo esc_html($type_labels[$notification->type] ?? $notification->type); ?>
                                    </span>
                                </td>
                                <td><?php echo esc_html($notification->title); ?></td>
                                <td><?php echo esc_html(wp_trim_words($notification->message, 15)); ?></td>
                                <td><?php echo esc_html($user ? $user->display_name : 'Ú©Ø§Ø±Ø¨Ø± Ø­Ø°Ù Ø´Ø¯Ù‡'); ?></td>
                                <td><?php echo esc_html(jozveraygan_gregorian_to_jalali($notification->created_at)); ?></td>
                                <td><?php echo $notification->is_read ? 'âœ“ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡' : 'â— Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡'; ?></td>
                            </tr>
                        <?php endforeach; ?>
                    </table>
                </form>
            <?php else: ?>
                <p>Ù‡ÛŒÚ† Ø§Ø¹Ù„Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p>
            <?php endif; ?>
        </div>
    </div>
    <script>
        document.getElementById('select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.notification-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    </script>
    <?php
}

function jozveraygan_admin_panel() {
    global $wpdb;
    $agent_users = get_users(['role' => 'agent']);
    
    $search_query = '';
    if (isset($_GET['search']) && !empty($_GET['search'])) {
        $search_query = sanitize_text_field($_GET['search']);
    }
    
    if (!empty($search_query)) {
        $filtered_users = [];
        foreach ($agent_users as $user) {
            if (strpos($user->display_name, $search_query) !== false || 
                strpos($user->user_email, $search_query) !== false) {
                $filtered_users[] = $user;
            }
        }
        $agent_users = $filtered_users;
    }
    ?>
    <style>
        .jozveraygan-container{max-width:1200px;margin:15px auto;padding:15px}.jozveraygan-header{font-size:32px;color:#1a3c5e;margin-bottom:20px;text-align:center}.jozveraygan-card{background:#fff;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1);padding:20px;margin-bottom:20px}.jozveraygan-card h3{font-size:22px;color:#1a3c5e;margin-bottom:15px;text-align:right}.jozveraygan-card form{display:grid;gap:10px}.jozveraygan-card select,.jozveraygan-card input,.jozveraygan-card textarea{width:100%;padding:10px;border:1px solid #d1d9e0;border-radius:6px;font-size:13px}.jozveraygan-card button{background:#CC9B50;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:13px}.jozveraygan-card button:hover{background:#b5893f}.jozveraygan-card button.delete{background:#dc3545}.jozveraygan-card button.delete:hover{background:#c82333}.jozveraygan-notification{padding:10px;border-radius:6px;margin-bottom:15px;text-align:center;font-size:13px}.jozveraygan-notification.jozveraygan-success{background:#e6f4ea;color:#2e7d32}.jozveraygan-notification.jozveraygan-error{background:#f8d7da;color:#721c24}.jozveraygan-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:15px;background:#fff;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.05)}.jozveraygan-table th,.jozveraygan-table td{border:1px solid #e0e6ed;padding:10px;text-align:right;font-size:13px}.jozveraygan-table th{background:#f8fafc;color:#1a3c5e}.jozveraygan-table tr:hover{background:#f4f6f9}.jozveraygan-table button{background:#d32f2f;color:#fff;padding:6px 12px;border-radius:5px;font-size:12px}.jozveraygan-table button:hover{background:#b71c1c}.jozveraygan-search{display:flex;gap:10px;margin-bottom:20px;align-items:center}.jozveraygan-search input{flex:1;padding:10px;border:1px solid #d1d9e0;border-radius:6px}.jozveraygan-search button{background:#CC9B50;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer}
    </style>
    <div class="jozveraygan-container">
        <h1 class="jozveraygan-header">Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†</h1>
        <div class="jozveraygan-card">
            <h3>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</h3>
            <form method="get" class="jozveraygan-search">
                <input type="hidden" name="page" value="jozveraygan-panel">
                <input type="text" name="search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… ÛŒØ§ Ø§ÛŒÙ…ÛŒÙ„..." value="<?php echo esc_attr($search_query); ?>">
                <button type="submit">Ø¬Ø³ØªØ¬Ùˆ</button>
                <?php if (!empty($search_query)): ?>
                    <a href="?page=jozveraygan-panel" style="background:#d32f2f;color:#fff;padding:10px 20px;border-radius:6px;text-decoration:none;">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</a>
                <?php endif; ?>
            </form>
        </div>
        <div class="jozveraygan-card">
            <h3>Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</h3>
            <form method="post" enctype="multipart/form-data">
                <input type="hidden" name="nonce" value="<?php echo wp_create_nonce('jozveraygan_admin_action'); ?>">
                <select name="user_id" required><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±</option><?php foreach (get_users() as $u) echo '<option value="' . esc_attr($u->ID) . '">' . esc_html($u->display_name) . '</option>'; ?></select>
                <label>ØªÙˆÚ©Ù† Marzban</label><input type="text" name="marzban_token" required>
                <label>Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</label><input type="file" name="profile_picture" accept="image/jpeg,image/png,image/jpg">
                <button type="submit" name="add_agent">Ø§ÙØ²ÙˆØ¯Ù†</button>
            </form>
            <?php
            if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_agent']) && !empty($_POST['user_id']) && wp_verify_nonce($_POST['nonce'], 'jozveraygan_admin_action')) {
                $user_id = absint($_POST['user_id']);
                $user = new WP_User($user_id);
                $user->add_role('agent');
                if (!empty($_POST['marzban_token'])) update_user_meta($user_id, 'jozveraygan_marzban_token', sanitize_text_field($_POST['marzban_token']));
                if (!empty($_FILES['profile_picture']['name']) && in_array($_FILES['profile_picture']['type'], ['image/jpeg', 'image/png', 'image/jpg']) && $_FILES['profile_picture']['size'] <= 2 * 1024 * 1024) {
                    require_once ABSPATH . 'wp-admin/includes/file.php';
                    require_once ABSPATH . 'wp-admin/includes/media.php';
                    require_once ABSPATH . 'wp-admin/includes/image.php';
                    $attachment_id = media_handle_upload('profile_picture', 0);
                    if (!is_wp_error($attachment_id)) update_user_meta($user_id, 'jozveraygan_profile_picture', esc_url_raw(wp_get_attachment_url($attachment_id)));
                }
                echo '<div class="jozveraygan-notification jozveraygan-success">Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.</div>';
            }
            if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_agent']) && !empty($_POST['delete_user_id']) && wp_verify_nonce($_POST['nonce'], 'jozveraygan_admin_action')) {
                $user_id = absint($_POST['delete_user_id']);
                $user = new WP_User($user_id);
                $user->remove_role('agent');
                delete_user_meta($user_id, 'jozveraygan_marzban_token');
                delete_user_meta($user_id, 'jozveraygan_profile_picture');
                echo '<div class="jozveraygan-notification jozveraygan-success">Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø­Ø°Ù Ø´Ø¯.</div>';
            }
            ?>
        </div>
        <div class="jozveraygan-card">
            <h3>Ù„ÛŒØ³Øª Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†</h3>
            <?php if (!empty($search_query)): ?>
                <p><strong>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ:</strong> "<?php echo esc_html($search_query); ?>" (<?php echo count($agent_users); ?> Ù†ØªÛŒØ¬Ù‡)</p>
            <?php endif; ?>
            <table class="jozveraygan-table">
                <tr><th>Ù†Ø§Ù…</th><th>Ø§ÛŒÙ…ÛŒÙ„</th><th>ØªÙˆÚ©Ù†</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
                <?php
                if ($agent_users) {
                    foreach ($agent_users as $user) {
                        $token = get_user_meta($user->ID, 'jozveraygan_marzban_token', true) ?: 'ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡';
                        echo '<tr>';
                        echo '<td>' . esc_html($user->display_name) . '</td>';
                        echo '<td>' . esc_html($user->user_email) . '</td>';
                        echo '<td>' . esc_html(substr($token, 0, 10) . '...') . '</td>';
                        echo '<td>';
                        echo '<form method="post" style="display:inline" onsubmit="return confirm(\'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ\');"><input type="hidden" name="nonce" value="' . wp_create_nonce('jozveraygan_admin_action') . '"><input type="hidden" name="delete_user_id" value="' . $user->ID . '"><button type="submit" name="delete_agent" class="delete">Ø­Ø°Ù</button></form>';
                        echo '</td>';
                        echo '</tr>';
                    }
                } else {
                    echo '<tr><td colspan="4">Ù‡ÛŒÚ† Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
                }
                ?>
            </table>
        </div>
    </div>
    <?php
}

function jozveraygan_users_panel() {
    global $wpdb;
    $agent_users = get_users(['role' => 'agent']);
    ?>
    <style>
        .jozveraygan-container{max-width:1000px;margin:15px auto;padding:15px}.jozveraygan-header{font-size:32px;color:#1a3c5e;margin-bottom:20px;text-align:center}.jozveraygan-card{background:#fff;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1);padding:20px;margin-bottom:20px}.jozveraygan-card h3{font-size:22px;color:#1a3c5e;margin-bottom:15px;text-align:right}.jozveraygan-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:15px;background:#fff;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,0.05)}.jozveraygan-table th,.jozveraygan-table td{border:1px solid #e0e6ed;padding:10px;text-align:right;font-size:13px}.jozveraygan-table th{background:#f8fafc;color:#1a3c5e}.jozveraygan-table tr:hover{background:#f4f6f9}
    </style>
    <div class="jozveraygan-container">
        <h1 class="jozveraygan-header">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>
        <div class="jozveraygan-card">
            <h3>Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
            <table class="jozveraygan-table">
                <tr><th>Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</th><th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th><th>Ø­Ø¬Ù… (GB)</th><th>Ø§Ù†Ù‚Ø¶Ø§</th><th>ÙˆØ¶Ø¹ÛŒØª</th></tr>
                <?php
                $has_users = false;
                foreach ($agent_users as $agent) {
                    $token = get_user_meta($agent->ID, 'jozveraygan_marzban_token', true);
                    $users = jozveraygan_get_marzban_users($token);
                    foreach ($users as $u) {
                        $has_users = true;
                        $data_limit = round($u['data_limit'] / (1024 * 1024 * 1024), 2);
                        $expire = $u['expire'] ? date('Y-m-d', $u['expire']) : 'Ø¨Ø¯ÙˆÙ† Ø§Ù†Ù‚Ø¶Ø§';
                        $status = $u['status'] === 'active' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„';
                        echo '<tr>';
                        echo '<td>' . esc_html($agent->display_name) . '</td>';
                        echo '<td>' . esc_html($u['username']) . '</td>';
                        echo '<td>' . esc_html($data_limit) . '</td>';
                        echo '<td>' . esc_html($expire) . '</td>';
                        echo '<td>' . esc_html($status) . '</td>';
                        echo '</tr>';
                    }
                }
                if (!$has_users) echo '<tr><td colspan="5">Ø¨Ø¯ÙˆÙ† Ú©Ø§Ø±Ø¨Ø±.</td></tr>';
                ?>
            </table>
        </div>
    </div>
    <?php
}
?>
```

### ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø¯
1. **Ø³Ø§Ø®ØªØ§Ø± Ø§ÙØ²ÙˆÙ†Ù‡**: Ø§ÙØ²ÙˆÙ†Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© Ø§ÙØ²ÙˆÙ†Ù‡ ÙˆØ±Ø¯Ù¾Ø±Ø³ Ø¹Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø´ÙˆØ±Øªâ€ŒÚ©Ø¯ `[jozveraygan-agent]` Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
2. **Ø§ØªØµØ§Ù„ Ø¨Ù‡ Marzban**: Ø§Ø² ØªØ§Ø¨Ø¹ `jozveraygan_marzban_api_request` Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ HTTP Ø¨Ù‡ API Marzban Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§Ø² `wp_remote_request` ÙˆØ±Ø¯Ù¾Ø±Ø³ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø§Ù…Ù† Ùˆ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø§Ø³Øª.
3. **Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†**: Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ù†Ø¯ØŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†Ù†Ø¯ ÛŒØ§ Ø­Ø°Ù Ú©Ù†Ù†Ø¯. Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒØŒ Ø­Ø¬Ù…ØŒ ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§) Ø§Ø² API Marzban Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆØ¯.
4. **Ù†Ù‚Ø´ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡**: Ù†Ù‚Ø´ `agent` Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† `modares` Ø´Ø¯Ù‡ Ùˆ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù† Ø¨Ø§ Ø§ÛŒÙ† Ù†Ù‚Ø´ Ø¨Ù‡ Ù¾Ù†Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±Ù†Ø¯. ØªÙˆÚ©Ù† API Ù‡Ø± Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø¯Ø± Ù…ØªØ§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
5. **Ø§Ø¹Ù„Ø§Ù†Ø§Øª**: Ø³ÛŒØ³ØªÙ… Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø´Ø§Ø¨Ù‡ Ú©Ø¯ Ø§ØµÙ„ÛŒ Ø­ÙØ¸ Ø´Ø¯Ù‡ Ùˆ Ø¨Ø±Ø§ÛŒ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø§ÛŒØ¬Ø§Ø¯ØŒ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ø­Ø°Ù) Ø§Ø¹Ù„Ø§Ù† ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
6. **Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†**: Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù† Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ ÛŒØ§ Ø­Ø°Ù Ú©Ù†Ø¯ Ùˆ ØªÙˆÚ©Ù† Marzban Ø¢Ù†Ù‡Ø§ Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†Ø¯. Ù‡Ù…Ú†Ù†ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù† Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†Ø¯.
7. **Ø­ÙØ¸ Ø¸Ø§Ù‡Ø±**: ØªÙ…Ø§Ù… Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ CSS Ùˆ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ù…Ø§Ù†Ù†Ø¯ Ù…Ù†ÙˆÛŒ Ú©Ù†Ø§Ø±ÛŒØŒ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ùˆ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§) Ø§Ø² Ú©Ø¯ Ø§ØµÙ„ÛŒ Ú©Ù¾ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ Ùˆ ÙÙ‚Ø· Ù†Ø§Ù… Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ Ø¨Ù‡ `jozveraygan-` ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡â€ŒØ§Ù†Ø¯.
8. **ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯**: Ø¨Ø®Ø´ ØªØ­Ù„ÛŒÙ„ ÙÙ‚Ø· ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø¹Ø¯Ø§Ù‹ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±ÛŒ Ø§Ø² Marzban Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯).

### Ù†ØµØ¨ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
1. **Ù†ØµØ¨ Ø§ÙØ²ÙˆÙ†Ù‡**:
   - ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø± Ù¾ÙˆØ´Ù‡ `wp-content/plugins` Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø¨Ù‡ Ù†Ø§Ù… `jozveraygan-agent.php`).
   - Ø§ÙØ²ÙˆÙ†Ù‡ Ø±Ø§ Ø§Ø² Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† ÙˆØ±Ø¯Ù¾Ø±Ø³ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.
2. **ØªÙ†Ø¸ÛŒÙ… ØªÙˆÚ©Ù†**:
   - Ø¯Ø± Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†ØŒ Ø¨Ù‡ Ø¨Ø®Ø´ Â«Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù†Â» Ø¨Ø±ÙˆÛŒØ¯ Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ ÛŒÚ© ØªÙˆÚ©Ù† API Ø§Ø² Marzban ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.
3. **Ø§ÛŒØ¬Ø§Ø¯ ØµÙØ­Ù‡ Ù¾Ù†Ù„**:
   - ÛŒÚ© ØµÙØ­Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± ÙˆØ±Ø¯Ù¾Ø±Ø³ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ø´ÙˆØ±Øªâ€ŒÚ©Ø¯ `[jozveraygan-agent]` Ø±Ø§ Ø¯Ø± Ø¢Ù† Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.
4. **Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ API Marzban**:
   - Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø³Ø±ÙˆØ± Marzban Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª Ùˆ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ API Ù…Ø¹ØªØ¨Ø± Ù‡Ø³ØªÙ†Ø¯.
   - Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ø§Ø² SSL Ù…Ø¹ØªØ¨Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ø§Ø´Ø¯ `sslverify` Ø±Ø§ Ø¯Ø± ØªØ§Ø¨Ø¹ `jozveraygan_marzban_api_request` Ø¨Ù‡ `false` ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ (Ø§ÛŒÙ† Ú©Ø§Ø± ØªÙˆØµÛŒÙ‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ù…Ú¯Ø± Ø¯Ø± Ù…Ø­ÛŒØ· ØªØ³Øª).

### Ù†Ú©Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ
- **ØªÙˆÚ©Ù† API**: ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Marzban Ø¨Ø§ÛŒØ¯ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø§Ù…Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆÙ†Ø¯ Ùˆ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯.
- **Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§**: ØªÙ…Ø§Ù… ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ ÙØ±Ù… Ø¨Ø§ `sanitize_text_field` Ùˆ `wp_verify_nonce` Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
- **SSL**: Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ API Ø¨Ø§ `sslverify => true` Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ ØªØ§ Ø§Ù…Ù†ÛŒØª Ø­ÙØ¸ Ø´ÙˆØ¯.
- **Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ**: ÙÙ‚Ø· Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ Ù†Ù‚Ø´ `agent` Ø¨Ù‡ Ù¾Ù†Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±Ù†Ø¯ Ùˆ ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯Ø§Ù† Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†Ù†Ø¯.

### Ú¯Ø³ØªØ±Ø´â€ŒÙ¾Ø°ÛŒØ±ÛŒ
- Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±ÛŒ Ù…Ø§Ù†Ù†Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§ÛŒ VPNØŒ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ±Ø§ÙÛŒÚ© Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ØŒ ÛŒØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡â€ŒØªØ± Ø±Ø§ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² APIÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Marzban Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.
- Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ù…ÙˆØ±Ø¯ APIÙ‡Ø§ÛŒ MarzbanØŒ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø±Ø³Ù…ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø¯Ø± GitHub Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯: [Gozargah/Marzban](https://github.com/Gozargah/Marzban).

### Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§
- Ø§ÛŒÙ† Ú©Ø¯ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ API Marzban Ø±ÙˆÛŒ `https://admin.jozveraygan.xyz:8443` Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª. Ø§Ú¯Ø± Ø¢Ø¯Ø±Ø³ ÛŒØ§ Ù¾ÙˆØ±Øª ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ø¯Ø± ØªØ§Ø¨Ø¹ `jozveraygan_marzban_api_request` Ø§ØµÙ„Ø§Ø­ Ø´ÙˆØ¯.
- Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡â€ŒØªØ± Marzban (Ù…Ø§Ù†Ù†Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆØ±Ù‡Ø§ ÛŒØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÚ©Ø³ÛŒ) Ø¯Ø± Ø§ÛŒÙ† Ú©Ø¯ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ØŒ Ø§Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù†Ù‡Ø§ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.

Ø§Ú¯Ø± Ø³Ø¤Ø§Ù„ ÛŒØ§ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØºÛŒÛŒØ± Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹ Ø¯Ù‡ÛŒØ¯!
